name: Auto-merge

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled, ready_for_review]

permissions:
  pull-requests: write
  contents: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge when labeled
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);

            const hasAutomerge = labels.includes("automerge");
            const blocked = labels.includes("do-not-merge");

            if (!hasAutomerge || blocked) {
              core.info("Automerge not enabled (missing automerge label or blocked).");
              return;
            }

            await github.graphql(`
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }) {
                  pullRequest { number autoMergeRequest { enabledAt } }
                }
              }
            `, { pullRequestId: pr.node_id });

            core.info("Auto-merge enabled.");
