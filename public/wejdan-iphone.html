<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>WejdanAI - Qwen Chat</title>

  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WejdanAI">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Favicon -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231e3a5f' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>W</text></svg>">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
      color: #fff;
      min-height: 100vh;
      min-height: 100dvh;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 16px 20px;
      padding-top: calc(env(safe-area-inset-top, 20px) + 16px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 28px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .model-badge {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Chat area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 120px;
      -webkit-overflow-scrolling: touch;
    }

    /* Welcome */
    .welcome {
      text-align: center;
      padding: 40px 20px;
    }

    .welcome-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .welcome h2 {
      font-size: 24px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome p {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 30px;
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .suggestion {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion:active {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(0.98);
    }

    /* Messages */
    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .content {
      max-width: 80%;
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      font-size: 15px;
      word-wrap: break-word;
    }

    .message.user .bubble {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-radius: 18px 4px 18px 18px;
    }

    .message.assistant .bubble {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 4px 18px 18px 18px;
    }

    .time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 4px;
      padding: 0 4px;
    }

    .message.user .time {
      text-align: left;
    }

    /* Typing indicator */
    .typing {
      display: flex;
      gap: 6px;
      padding: 16px;
    }

    .typing span {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Input area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(13, 27, 42, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 16px;
      padding-bottom: calc(env(safe-area-inset-bottom, 16px) + 16px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-container textarea {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 14px 20px;
      color: #fff;
      font-size: 16px;
      resize: none;
      outline: none;
      font-family: inherit;
      max-height: 120px;
      direction: rtl;
    }

    .input-container textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .input-container textarea:focus {
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.15);
    }

    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn:disabled {
      opacity: 0.5;
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-btn svg {
      width: 22px;
      height: 22px;
      transform: rotate(180deg);
    }

    /* Settings button */
    .settings-btn {
      position: fixed;
      top: calc(env(safe-area-inset-top, 20px) + 70px);
      left: 16px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 20px;
      cursor: pointer;
      z-index: 100;
    }

    .settings-btn:active {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Settings modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e3a5f, #0d1b2a);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-content h3 {
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .field {
      margin-bottom: 16px;
    }

    .field label {
      display: block;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
    }

    .field input,
    .field select {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      color: #fff;
      font-size: 16px;
      outline: none;
      direction: ltr;
    }

    .field input:focus,
    .field select:focus {
      border-color: #3b82f6;
    }

    .field select option {
      background: #1e3a5f;
      color: #fff;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .save-btn {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }

    .clear-btn {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3) !important;
      margin-top: 12px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 16px) + 100px);
      left: 50%;
      transform: translateX(-50%);
      background: #ef4444;
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      max-width: calc(100% - 40px);
    }

    .toast.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .toast button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
    }

    /* Code blocks */
    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
    }

    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }

    pre code {
      background: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ğŸ¤–</span>
        <span class="logo-text">WejdanAI</span>
      </div>
      <div class="model-badge" id="modelBadge">Qwen Max</div>
    </header>

    <!-- Chat area -->
    <main class="chat-area" id="chatArea">
      <div class="welcome" id="welcome">
        <div class="welcome-icon">âœ¨</div>
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ WejdanAI</h2>
        <p>Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù†Ù…ÙˆØ°Ø¬ Qwen3 Ù…Ù† Alibaba Cloud</p>
        <div class="suggestions">
          <button class="suggestion" onclick="sendSuggestion('Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ')">Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ</button>
          <button class="suggestion" onclick="sendSuggestion('Ø§ÙƒØªØ¨ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©')">Ø§ÙƒØªØ¨ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©</button>
          <button class="suggestion" onclick="sendSuggestion('Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©')">Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙÙŠ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø©</button>
          <button class="suggestion" onclick="sendSuggestion('ØªØ±Ø¬Ù… Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©')">ØªØ±Ø¬Ù… Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</button>
        </div>
      </div>
    </main>

    <!-- Input area -->
    <footer class="input-area">
      <div class="input-container">
        <textarea
          id="userInput"
          placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
          rows="1"
          onkeydown="handleKeydown(event)"
        ></textarea>
        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
          </svg>
        </button>
      </div>
    </footer>

    <!-- Settings button -->
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>

    <!-- Settings modal -->
    <div class="modal" id="settingsModal" onclick="closeModalOnBackdrop(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div class="field">
          <label>Ù…ÙØªØ§Ø­ DashScope API</label>
          <input type="password" id="apiKeyInput" placeholder="sk-..." dir="ltr">
          <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">
            Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­Ùƒ Ù…Ù†: <a href="https://dashscope.console.aliyun.com" target="_blank" style="color: #60a5fa;">DashScope Console</a>
          </p>
        </div>
        <div class="field">
          <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
          <select id="modelSelect">
            <option value="qwen-max">Qwen Max (Ø§Ù„Ø£Ù‚ÙˆÙ‰)</option>
            <option value="qwen-plus">Qwen Plus (Ù…ØªÙˆØ§Ø²Ù†)</option>
            <option value="qwen-turbo">Qwen Turbo (Ø§Ù„Ø£Ø³Ø±Ø¹)</option>
          </select>
        </div>
        <div class="modal-actions">
          <button class="save-btn" onclick="saveSettings()">Ø­ÙØ¸</button>
          <button class="cancel-btn" onclick="closeSettings()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <button class="clear-btn" onclick="clearChat()" style="width: 100%;">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <span id="toastMessage"></span>
      <button onclick="hideToast()">Ã—</button>
    </div>
  </div>

  <script>
    // State
    let messages = [];
    let apiKey = '';
    let model = 'qwen-max';
    let isLoading = false;

    // DOM elements
    const chatArea = document.getElementById('chatArea');
    const welcome = document.getElementById('welcome');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const settingsModal = document.getElementById('settingsModal');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const modelBadge = document.getElementById('modelBadge');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    // Initialize
    function init() {
      loadSettings();
      loadMessages();
      renderMessages();
      updateModelBadge();
    }

    // Settings
    function loadSettings() {
      apiKey = localStorage.getItem('wejdan_api_key') || '';
      model = localStorage.getItem('wejdan_model') || 'qwen-max';
      apiKeyInput.value = apiKey;
      modelSelect.value = model;
    }

    function saveSettings() {
      apiKey = apiKeyInput.value.trim();
      model = modelSelect.value;
      localStorage.setItem('wejdan_api_key', apiKey);
      localStorage.setItem('wejdan_model', model);
      updateModelBadge();
      closeSettings();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
    }

    function updateModelBadge() {
      const modelNames = {
        'qwen-max': 'Qwen Max',
        'qwen-plus': 'Qwen Plus',
        'qwen-turbo': 'Qwen Turbo'
      };
      modelBadge.textContent = modelNames[model] || model;
    }

    function openSettings() {
      apiKeyInput.value = apiKey;
      modelSelect.value = model;
      settingsModal.classList.add('active');
    }

    function closeSettings() {
      settingsModal.classList.remove('active');
    }

    function closeModalOnBackdrop(event) {
      if (event.target === settingsModal) {
        closeSettings();
      }
    }

    // Messages
    function loadMessages() {
      const saved = localStorage.getItem('wejdan_messages');
      if (saved) {
        try {
          messages = JSON.parse(saved);
        } catch (e) {
          messages = [];
        }
      }
    }

    function saveMessages() {
      localStorage.setItem('wejdan_messages', JSON.stringify(messages));
    }

    function renderMessages() {
      if (messages.length === 0) {
        welcome.style.display = 'block';
        return;
      }

      welcome.style.display = 'none';

      // Clear existing messages (except welcome)
      const existingMsgs = chatArea.querySelectorAll('.message');
      existingMsgs.forEach(msg => msg.remove());

      messages.forEach(msg => {
        addMessageToDOM(msg);
      });

      scrollToBottom();
    }

    function addMessageToDOM(msg) {
      const div = document.createElement('div');
      div.className = `message ${msg.role}`;

      const time = msg.timestamp ? formatTime(msg.timestamp) : '';

      div.innerHTML = `
        <div class="avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
        <div class="content">
          <div class="bubble">${formatContent(msg.content)}</div>
          <div class="time">${time}</div>
        </div>
      `;

      chatArea.appendChild(div);
    }

    function formatContent(text) {
      if (!text) return '';
      return text
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
    }

    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function scrollToBottom() {
      setTimeout(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
      }, 100);
    }

    function clearChat() {
      messages = [];
      saveMessages();
      renderMessages();
      closeSettings();
      showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
    }

    // Send message
    function handleKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function sendSuggestion(text) {
      userInput.value = text;
      sendMessage();
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text || isLoading) return;

      if (!apiKey) {
        openSettings();
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }

      // Hide welcome
      welcome.style.display = 'none';

      // Add user message
      const userMsg = {
        role: 'user',
        content: text,
        timestamp: new Date().toISOString()
      };
      messages.push(userMsg);
      addMessageToDOM(userMsg);
      saveMessages();

      userInput.value = '';
      isLoading = true;
      sendBtn.disabled = true;

      // Add typing indicator
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message assistant';
      typingDiv.id = 'typing';
      typingDiv.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="content">
          <div class="typing"><span></span><span></span><span></span></div>
        </div>
      `;
      chatArea.appendChild(typingDiv);
      scrollToBottom();

      try {
        // Prepare messages for API
        const apiMessages = messages.map(m => ({
          role: m.role,
          content: m.content
        }));

        // Add system message
        const systemMessage = {
          role: 'system',
          content: 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙ…ÙÙŠØ¯. ØªØ¬ÙŠØ¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø£Ø®Ø±Ù‰. ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ø®ØªØµØ±Ø§Ù‹ ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.'
        };

        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: model,
            input: {
              messages: [systemMessage, ...apiMessages]
            },
            parameters: {
              result_format: 'message',
              temperature: 0.7,
              top_p: 0.8,
              max_tokens: 2000
            }
          })
        });

        // Remove typing indicator
        const typing = document.getElementById('typing');
        if (typing) typing.remove();

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­');
          } else if (response.status === 429) {
            throw new Error('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹');
          } else {
            throw new Error(`Ø®Ø·Ø£: ${response.status}`);
          }
        }

        const data = await response.json();

        let content = '';
        if (data.output?.choices?.[0]?.message?.content) {
          content = data.output.choices[0].message.content;
        } else if (data.output?.text) {
          content = data.output.text;
        } else if (data.code) {
          throw new Error(data.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
        }

        if (!content) {
          throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙØ§Ø±ØºØ©');
        }

        // Add assistant message
        const assistantMsg = {
          role: 'assistant',
          content: content,
          timestamp: new Date().toISOString()
        };
        messages.push(assistantMsg);
        addMessageToDOM(assistantMsg);
        saveMessages();

      } catch (error) {
        // Remove typing indicator
        const typing = document.getElementById('typing');
        if (typing) typing.remove();

        console.error('Error:', error);
        showToast(error.message || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        scrollToBottom();
      }
    }

    // Toast
    function showToast(message, type = 'error') {
      toastMessage.textContent = message;
      toast.style.background = type === 'success' ? '#22c55e' : '#ef4444';
      toast.classList.add('active');
      setTimeout(hideToast, 3000);
    }

    function hideToast() {
      toast.classList.remove('active');
    }

    // Auto-resize textarea
    userInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Initialize
    init();
  </script>
</body>
</html>
